# gar2

Синхронизация адресного справочника ГАР с локальной базой регионов.

## Getting started

Для работы потребуються несколько библиотек Perl. Работа с исходными фалами выгрузки происходит исключительно через PIPE без распаковки архива на диск или создания временных файлов. Существенно экономится место и повышаеться скорость работы.

Установка для pacman:
```shell
pacman -S extra/perl-json-parse
pacman -S extra/perl-data-dump
pacman -S extra/perl-config-simple
pacman -S extra/perl-dbd-pg
install from AUR https://aur.archlinux.org/packages/perl-dbix-runsql
```
## Подготовка базы данных

Рекомендуем создать пользователя Postgres gar от имени которого будут выполняться все действия.
Так-же справочник ГАР лучше разместить в отдельной схеме в БД, что-бы небыло пересечений пространства имен таблиц.

Отредактируйте файл с конфигурацией gar.cfg

Создайте пользователя и схему. Имя схемы может быть любым. При работе с БД все действия выполняються в CURRENT_SCHEMA().
```shell
CREATE ROLE gar LOGIN PASSWORD 'password';
CREATE SCHEMA gar AUTHORIZATION gar;
ALTER ROLE gar SET search_path TO 'gar', 'public';
```

После этого можно запустить "gar.pl --init=<регион>". При первом старте он скачает список всех обновлений и закачает последнее полное обновление. Так-же создаст структуру ГАР в базе данных на основании парсинга полной выгрузки указанного региона. И загрузит данные этого региона. Запускать 1 раз или при изменении формата ГАР справочника. Эта операция пересоздает все таблицы.

gar.pl --add-region=<регион> - загружает новый регион в БД из предварительно скаченных файлов.
gar.pl --del-region=<регион> - удаляет регион из БД.
gar.pl --update - обновляет БД (загружает необходимые delta файлы регионов добавленных ранее через --add-region и вносит изменения в локальную базу ГАР).
gar.pl --show-status - показывает текущий статус выгрузки

необязательные параметры:
--config=<file> - откуда читать конфигурацию
