# gar2postgres

Синхронизация адресного справочника [ФИАС (Федеральная информационная адресная система)](https://fias.nalog.ru/) с локальной базой в postgres только нужных регионов.

## Getting started

Для работы потребуються несколько библиотек Perl. Работа с исходными файлами выгрузки происходит исключительно через PIPE без распаковки архива на диск или создания временных файлов. Существенно экономится место и повышаеться скорость работы.

Установка для pacman (archlinux):
```shell
pacman -S extra/wget
pacman -S extra/unzip
pacman -S extra/perl-json-parse
pacman -S extra/perl-data-dump
pacman -S extra/perl-config-simple
pacman -S extra/perl-dbd-pg
install from AUR https://aur.archlinux.org/packages/perl-dbix-runsql
```
## Подготовка базы данных

Рекомендуем создать пользователя Postgres gar от имени которого будут выполняться все действия.
Так-же справочник ГАР лучше разместить в отдельной схеме в БД, что-бы небыло пересечений пространства имен таблиц.

Отредактируйте файл с конфигурацией **gar.cfg**

Создайте пользователя и схему. При работе с БД все действия выполняються в CURRENT_SCHEMA(). По этому важно search_path прописать для пользователя. Имя схемы может быть любым, но лучше оставить gar, особенно если вы будите использовать **functions.sql** и **using.sql**.
```shell
CREATE ROLE gar LOGIN PASSWORD 'password';
CREATE SCHEMA gar AUTHORIZATION gar;
ALTER ROLE gar SET search_path TO 'gar';
```

После этого можно запустить `gar.pl --init=<регион>`. При первом старте он скачает список всех обновлений и закачает последнее полное обновление. Так-же создаст структуру ГАР в базе данных на основании парсинга полной выгрузки указанного региона. Запускать 1 раз или при изменении формата ГАР справочника. Эта операция пересоздает все таблицы.
Далее уже можно выполнять:

```gar.pl --add-region=<регион> - загружает новый регион в БД из предварительно скаченных файлов.
gar.pl --del-region=<регион> - удаляет регион из БД.
gar.pl --update - обновляет БД
gar.pl --show-status - показывает текущий статус выгрузки

необязательные параметры:
--config=<file> - откуда читать конфигурацию
```
## Немного о самом справочнике ГАР

reestr_objects - тут перечислены все объекты которые можно найти в адресном справочнике. objectid выступает как уникальное поле.
в общем реестре (reestr_objects) ISACTIVE означает что этот объект уже не активен и не должен быть использован в дальнейшем, но он может быть еще актуален!

В справочнике ГАР есть 6 типов объектов. Информация о которых храниться в отдельных таблицах:
    1. Здания (houses)
    2. Помещения (apartments)
    3. Комнаты (rooms)
    4. Земельные участки (steads)
    5. Парковочные места (carplaces)
    6. Элементы адреса (addr_obj).
Каждый из указанных объектов имеет определенный уровень (object_levels).
В зависимости от levelid информацию о объекте надо искать в разных таблицах:
1-8 Адреса (addr_obj)
    1 - Субъект РФ
    2 - Административный район
    3 - Муниципальный район
    4 - Сельское/городское поселение
    5 - Город
    6 - Населенный пункт
    7 - Элемент планировочной структуры
    8 - Элемент улично-дорожной сети
9 Земельные участки (steads)
10 Здания (houses)
11 Помещения (apartments)
12 Комнаты (rooms)
17 Парковочные места (carplaces)

Есть еще устаревшие уровни 13-16, но в адресах их практически нет... Можно принебречь.

У каждого из этих 5-ти объектов есть таблица в которой храняться дополнительные характеристики объекта ключ(code)=значение(name), которые относяться к данному типу объектов.
Таблицы эти называются *_params. Есть общий справочник параметров param_types, где перечисленны все возможные значения ключей.

Иерархия связей объектов строиться через 2 разных принципа административный и муниципальный, это отражено в 2-х таблицах:
    1. adm_hierarchy (деление территорий по административному принципу).
    2. mun_hierarchy (муниципальное деление) но мы ее не грузим в БД, так как не имеет большой ценности.

в таблицах присутствуют флаги ISACTIVE & ISACTUAL
isactual - это действующая, но не актуальная 
isactive - правильная и актуальная информация по объекту на которую и надо ориентироваться при ссылках

Пример:
select * from gar.addr_obj where objectid = 487658 or objectid = 164552691;

 changeid  |  enddate   |    id    | isactive | isactual | level |  name   |  nextid  |              objectguid              | objectid  | opertypeid |  previd  | startdate  | typename | updatedate | region 
-----------+------------+----------+----------+----------+-------+---------+----------+--------------------------------------+-----------+------------+----------+------------+----------+------------+--------
 601336924 | 2079-06-06 | 52127279 | f        | t        |     7 | Петушок | 52127278 | d0d43a08-9a4d-4016-bb5c-02bf8652588f |    487658 |         42 |   591479 | 2024-09-17 | снт      | 2024-09-17 |     31
   1235018 | 2024-09-17 |   591479 | f        | f        |     7 | Петушок | 52127279 | d0d43a08-9a4d-4016-bb5c-02bf8652588f |    487658 |         50 |   591430 | 2016-09-29 | снт      | 2024-09-17 |     31
   1234876 | 2016-09-29 |   591430 | f        | f        |    15 | Петушок |   591479 | d0d43a08-9a4d-4016-bb5c-02bf8652588f |    487658 |         10 |        0 | 2016-01-20 | снт      | 2017-12-10 |     31
 601336923 | 2079-06-06 | 52127278 | t        | t        |     7 | Петушок |          | a7ff1f03-1c13-47b1-8613-b33faf193fe4 | 164552691 |         40 | 52121920 | 2024-09-17 | тер. СНТ | 2024-09-17 |     31
 599227706 | 2024-09-17 | 52121920 | f        | f        |     7 | Петушок | 52127278 | a7ff1f03-1c13-47b1-8613-b33faf193fe4 | 164552691 |         10 |        0 | 2024-08-06 | тер. СНТ | 2024-09-17 |     31
(5 rows)

При формировании новых связей (ссылок) на этот СНТ надо использовать исключительно objectid = 164552691 с флагом isactive (id=52127278), но при этом старые записи ссылающиеся на objectid = 487658 не теряют своей актуальности, хотя по идее их быть уже не должно.

Соответственно мы можем выбрать все объекты имеющие какое-то отношение к адресной иерархии.

Получить все объекты в г.Таганроге:

WITH RECURSIVE res AS (
    SELECT objectid from adm_hierarchy where parentobjid in (select objectid from addr_obj where name = 'Таганрог') and isactive
UNION
    SELECT adm_hierarchy.objectid FROM adm_hierarchy JOIN res ON (adm_hierarchy.parentobjid = res.objectid )
) SELECT objectid,adm_fulladdress(objectid) from res;

Получить все многоквартирные дома в г. Таганроге:

select objectid,adm_fulladdress(objectid) from houses join houses_params using (objectid) where houses_params.typeid = 19 and houses.objectid in (WITH RECURSIVE res AS ( SELECT objectid from adm_hierarchy where parentobjid in (select objectid from addr_obj where name = 'Таганрог') and isactive UNION SELECT adm_hierarchy.objectid from adm_hierarchy JOIN res ON (adm_hierarchy.parentobjid = res.objectid ) ) SELECT * from res);

Полезные функции можно взять в functions.sql

В своем проекте я делаю MATERIALIZED VIEW в схеме public, что-бы было удобно работать с адресами. Смотрите using.sql
